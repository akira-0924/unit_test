# 第２章 単体テストとは何か？

## 単体テストの定義

古典学派(デトロイト学派)とロンドン学派がある。<br>

自動化されていて次の定義をすべて備えるものが単体テストとなる。

- 「単体(Unit)」と呼ばれる少量のコードを検証する
- 実行時間が短い
- **隔離**された状態で実行される

### 隔離とは？

**ロンドン学派**

- テスト対象システムから協力書オブジェクトを隔離する
  - つまり、テスト対象となるクラスが他のクラスに依存しているのであれば、その依存をすべてのテスト・ダブル（テストダブルとはテスト対象のコードが依存するオブジェクトのモックやスタブのこと）に置き換えなくてはならない
  - テスト・ダブルを使うことのメリットは、テストが失敗した時にコードベースでどこが問題なのかを特定しやすいことと、オブジェクト・グラフ（同じ問題を解決するために結びついたオブジェクトの集まり）を分離できるようになること
  - 要は、結合度を低くしているため、問題点を把握しやすいし、シンプルになる

### ロンドン派の書き方(隔離)

[test code](./list2.2.1.java)
各テスト・ケースの準備フェーズで検証に必要なテスト対象の全ての依存を準備して、続く実行フェースでテスト対象の振る舞いである customer.purchase()を実行している。

古典派の書き方。協力者オブジェクト(Srore クラス)をテストダブルに置き換えずそのまま使用している。その結果、**この単体テストは Customer クラスだけなく Store クラスも自然と検証していることになる**。← 隔離されていない

これをロンドン派の書き方に変えたものが以下になる。<br>
[test code](./list2.2.1.java)
Mock オブジェクトを使用している。
よって、実際の Store クラスは使用しないため、実際のクラスのオブジェクトの状態に関係なくテストができる。

**古典学派**
古典学派における**隔離**は、コードではなくてテストケースであり、各テストケースをお互いに影響を与えることなく個別に実行できるようにしなくてはならないということ。<br>このような隔離を行うことで複数のテストケースを同時に実行することも、逐次的に実行することも、順番関係なく実行することもでき、最も効果的なテストケースの実行順序を選択できる。

ただし、プロセス間依存が発生する可能性がある。例えば、準備フェーズで DB にデータを登録している場合、テストケースを並列で実行すると、データが競合してテストが失敗する可能性がある。なので、その部分はテスト・ダブルを使用して隔離する場合もある。

## 古典学派およびロンドン学派の考える単体テスト

隔離に対する考え方の違いとして、

- ロンドン学派
  - テスト対象システムをその協力者オブジェクトと隔離する
- 古典学派
  - 単体テストのテストケースをお互いに影響を与えることなく個別に実行できるようにする

がある。よって大きく分けて 3 つの視点において違いがある。

- どのような隔離をする必要があるのか
- テスト対象となる少量のコードを成り立たせるものは何か
- 依存をどのように扱うか
